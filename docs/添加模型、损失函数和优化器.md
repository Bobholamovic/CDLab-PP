# 添加模型、损失函数和优化器

添加模型、损失函数或优化器分为两个步骤：定义组件和编写建造器。

## 定义组件

组件按照正常 PaddlePaddle 规范定义，如模型和损失函数需继承自 `paddle.nn.Layer`，优化器需继承自 `paddle.optimizer.Optimizer`。除此之外，组件的定义不受到其它限制。

建议在 `src/models/` 目录下定义模型。该目录下的 `_blocks.py` 和 `_common.py` 提供了一些常用的底层和高层模块。

## 编写建造器

在 `src/impl/builders/` 目录下的相应文件中中编写建造器并注册：对于模型是 `src/impl/builders/model_builders.py`，对于损失函数是 `src/impl/builders/critn_builders.py`，对于优化器是 `src/impl/builders/optim_builders.py`。

每个组件可以有一个或一个以上的建造器，关于多个建造器的查找和匹配规则可参阅[此文档](./设计思想/工厂与建造器.md)。对于模型和损失函数，建造器接受[配置字典](./编写配置文件.md#配置字典)作为唯一参数，配置字典中中以键值对的形式包含有各种配置项。对于优化器，建造器接受需要优化的参数、学习率（或学习率调度器，遵循 PaddlePaddle 规范）以及配置字典3个参数。每个建造器被调用后返回一个相应的组件实例。

在编写完建造器后，需要对其进行注册，以便程序能够查找和发现建造器，并用其构建组件对象。建造器的注册可以在定义处使用装饰器语法糖实现，只需给定一个登记的名称作为参数。如模型建造器的注册可在建造器定义前添加 `@MODELS.register_func('new-model_model')`。对于模型建造器，其注册时的登记名需为`'XXX_model'` 格式；对于损失函数建造器，其注册时的登记名需为`'XXX_critn'` 格式；对于优化器，其注册时的登记名需为`'XXX_optim'` 格式。**建造器本身的名字不重要，真正用于查找建造器的是其在注册时登记的名字。**

在 `src/core/builders.py` 和 `src/impl/builders/` 中可以找到较多建造器的定义供开发者参考。